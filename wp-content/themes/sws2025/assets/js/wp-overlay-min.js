class WPOverlay{constructor(t={}){this.config={apiBase:"/wp-json/wp/v2",ajaxUrl:"undefined"!=typeof wp?wp.ajax_url:"/wp-admin/admin-ajax.php",animation:{openDuration:.6,closeDuration:.5,ease:"power3.inOut",scaleOrigin:20,background:"#FF6920",width:"1300"},classes:{container:"wp-overlay-container",backdrop:"wp-overlay-backdrop",wrap:"wp-overlay-content-wrap",content:"wp-overlay-content",body:"wp-overlay-body",close:"wp-overlay-close",loading:"wp-overlay-loading",error:"wp-overlay-error",active:"active",bodyLock:"wp-overlay-open",origin:"wp-overlay-origin"},debug:!1,...t},this.state={isOpen:!1,isAnimating:!1,currentContent:null,currentTarget:null,originPoint:{x:0,y:0},originElement:null,container:null,timeline:null,originalUrl:null,originalTitle:null,loadedScripts:new Set},this.init()}init(){this.createContainer(),document.querySelector('a[onclick^="Overlay.open"]')&&(this.setupGlobalAPI(),this.bindEvents(),this.debug("WPOverlay initialized "+this.state.container))}createContainer(){if(document.querySelector(`.${this.config.classes.container}`))return void(this.state.container=document.querySelector(`.${this.config.classes.container}`));const t=document.createElement("div");t.className=this.config.classes.container,t.innerHTML=`\n            <div class="${this.config.classes.backdrop}"></div>\n            <div class="${this.config.classes.wrap}">\n                <button class="${this.config.classes.close}" aria-label="Close">Zur Übersicht</button>\n                <div class="${this.config.classes.content}">\n                    <div class="${this.config.classes.body}">\n                        <div class="${this.config.classes.loading}">\n                            <div class="wp-overlay-spinner"></div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div class="${this.config.classes.origin}"></div>\n        `,document.body.appendChild(t),this.state.container=t,this.elements={container:t,wrap:t.querySelector(`.${this.config.classes.wrap}`),backdrop:t.querySelector(`.${this.config.classes.backdrop}`),content:t.querySelector(`.${this.config.classes.content}`),body:t.querySelector(`.${this.config.classes.body}`),title:t.querySelector(".wp-overlay-title"),close:t.querySelector(`.${this.config.classes.close}`),origin:t.querySelector(`.${this.config.classes.origin}`)},gsap.set(this.elements.content,{opacity:0,scale:0,visibility:"hidden"})}setupGlobalAPI(){window.Overlay={open:(t,e)=>this.open(t,e,!1),close:()=>this.close(!1),instance:this},document.addEventListener("click",(t=>{const e=t.target.closest("[data-overlay]");if(e){t.preventDefault();const i=e.dataset.overlay||e.href;this.open(i,t,!1)}}))}bindEvents(){this.elements.close.addEventListener("click",(()=>this.close())),this.elements.wrap.addEventListener("click",(t=>{t.target===this.elements.wrap&&this.close()})),this.elements.backdrop.addEventListener("click",(()=>this.close())),document.addEventListener("keydown",(t=>{"Escape"===t.key&&this.state.isOpen&&this.close()})),window.addEventListener("popstate",(t=>{t.state&&t.state.wpOverlay?this.open(t.state.target,null,!0):this.state.isOpen&&(this.debug("prevent and go back"),this.close(!0))}))}async open(t,e,i=!1){if(this.state.isAnimating||this.state.isOpen)return;this.state.isAnimating=!0,this.state.currentTarget=t,e?(this.state.originPoint={x:e.clientX||e.pageX,y:(e.clientY||e.pageY)-160},this.state.originElement=e.target):this.state.originPoint={x:window.innerWidth/2,y:window.innerHeight/2},gsap.set(this.elements.origin,{x:this.state.originPoint.x,y:this.state.originPoint.y,opacity:1}),document.body.classList.add(this.config.classes.bodyLock),this.state.container.classList.add(this.config.classes.active),this.state.originElement?.closest(".svg-path-container")?.classList.add("overlayOpen"),this.showLoading();const s=this.calculateBounds();this.animateOpen(s);try{const e=await this.loadContent(t);this.setContent(e),i||this.pushHistory(e)}catch(t){this.showError(t.message)}}calculateBounds(){const t=window.innerWidth,e=(window.innerHeight,Math.min(.9*t,this.config.animation.width));return{width:e,height:"auto",x:(t-e)/2,y:0}}animateOpen(t){this.state.timeline&&this.state.timeline.kill(),gsap.set(this.elements.content,{width:this.config.animation.scaleOrigin,height:this.config.animation.scaleOrigin,x:this.state.originPoint.x-this.config.animation.scaleOrigin/2,y:this.state.originPoint.y-this.config.animation.scaleOrigin/2,opacity:1,scale:1,visibility:"visible"});const e=gsap.timeline({onComplete:()=>{this.state.isAnimating=!1,this.state.isOpen=!0}});e.to(this.elements.backdrop,{opacity:1,duration:.6*this.config.animation.openDuration,ease:"power2.out"},0),e.to(this.elements.close,{opacity:1,duration:.6*this.config.animation.openDuration,ease:"power2.out"},0),e.to(this.elements.content,{width:t.width,height:t.height,x:t.x,y:t.y,duration:this.config.animation.openDuration,ease:this.config.animation.ease,background:"white"},0),e.to(this.elements.origin,{opacity:0,scale:2,duration:.5*this.config.animation.openDuration},.1),this.state.timeline=e}close(t=!1){if(this.state.isAnimating||!this.state.isOpen)return;this.state.isAnimating=!0,this.state.timeline&&this.state.timeline.kill(),gsap.set(this.elements.origin,{opacity:1,scale:1});const e=gsap.timeline({onComplete:()=>{this.state.isAnimating=!1,this.state.isOpen=!1,this.state.container.classList.remove(this.config.classes.active),document.body.classList.remove(this.config.classes.bodyLock),this.cleanupDynamicScripts(),this.state.originElement&&this.state.originElement.closest(".svg-path-container")?.classList.remove("overlayOpen"),this.resetContent(),gsap.set(this.elements.origin,{opacity:0}),!t&&this.state.originalUrl&&(history.pushState(null,"",this.state.originalUrl),this.state.originalUrl=null)}});e.to(this.elements.content,{width:this.config.animation.scaleOrigin,height:this.config.animation.scaleOrigin,x:this.state.originPoint.x-this.config.animation.scaleOrigin/2,y:this.state.originPoint.y-this.config.animation.scaleOrigin/2,duration:this.config.animation.closeDuration,ease:this.config.animation.ease,background:this.config.animation.background},0),e.to(this.elements.backdrop,{opacity:0,duration:.8*this.config.animation.closeDuration,ease:"power2.in"},0),e.to(this.elements.close,{opacity:0,duration:.8*this.config.animation.closeDuration,ease:"power2.in"},0),e.to(this.elements.origin,{opacity:0,scale:.5,duration:.5*this.config.animation.closeDuration},.2),e.set(this.elements.content,{opacity:0,visibility:"hidden"}),this.state.timeline=e}cleanupDynamicScripts(){this.state.loadedScripts.clear()}async loadContent(t){const e=this.parseTarget(t);let i;return"ajax"===e.type?i=await this.loadViaAjax(e.id):"rest"===e.type?i=await this.loadViaRest(e.id):"url"===e.type&&(i=await this.loadViaFetch(e.url)),i.url=e.url||this.generateUrl(e,i),i}pushHistory(t){this.state.originalUrl||(this.state.originalUrl=window.location.href,this.state.originalTitle=document.title);const e=t.url||window.location.href;t.title||document.title;history.pushState({wpOverlay:!0,target:this.state.currentTarget,title:this.state.originalTitle},this.state.originalTitle,e),document.title=this.state.originalTitle}generateUrl(t,e){return"ajax"===t.type&&e.slug?`/${e.slug}/`:"rest"===t.type&&t.id?`/${t.id}/`:window.location.href}parseTarget(t){if(!isNaN(t))return{type:"ajax",id:parseInt(t)};if(t.startsWith("http")||t.startsWith("/"))return{type:"url",url:t};if(t.startsWith("page-")){const e=t.replace("page-","");return{type:"ajax",id:parseInt(e)}}return{type:"rest",id:t}}async loadViaAjax(t){const e=new FormData;e.append("action","load_page_content"),e.append("page_id",t),e.append("nonce","undefined"!=typeof wpOverlay?wpOverlay.nonce:"");const i=await fetch(this.config.ajaxUrl,{method:"POST",body:e}),s=await i.json();if(!s.success)throw new Error(s.data.message||"Failed to load content");return{title:s.data.title,content:s.data.content,slug:s.data.slug,url:s.data.url,scripts:s.data.scripts||[]}}async loadViaRest(t){let e=`${this.config.apiBase}/pages`;isNaN(t)?e+=`?slug=${t}`:e+=`/${t}`;const i=await fetch(e),s=await i.json(),n=Array.isArray(s)?s[0]:s;if(!n)throw new Error("Page not found");let a=[];try{const t=await fetch(`${this.config.apiBase}/page-scripts/${n.id}`);a=await t.json()}catch(t){this.debug("Could not load scripts info:",t)}return{title:n.title.rendered,content:n.content.rendered,scripts:a}}async loadViaFetch(t){const e=await fetch(t),i=await e.text(),s=(new DOMParser).parseFromString(i,"text/html"),n=s.querySelector(".entry-content, .post-content, main, article, #content"),a=s.querySelector("h1, .entry-title, .post-title"),o=this.extractScriptsFromDocument(s,n);return{title:a?a.textContent:"Content",content:n?n.innerHTML:i,scripts:o}}extractScriptsFromDocument(t,e){const i=[],s=/wp-block-custom-(\w+)/;if(e){const n=e.querySelectorAll('[class*="wp-block-custom-"]'),a=new Set;n.forEach((t=>{const e=t.className.match(s);e&&a.add(e[1])})),t.querySelectorAll('script[src*="/blocks/"]').forEach((t=>{const e=t.getAttribute("src");a.forEach((t=>{e.includes(`/blocks/${t}/frontend.js`)&&i.push({handle:`${t}-frontend-script`,src:e.split("?")[0],version:e.includes("ver=")?e.split("ver=")[1]:"1.0.0"})}))})),t.querySelectorAll("script").forEach((t=>{const e=t.getAttribute("id");if(e&&e.includes("-frontend-script-js")){const s=t.getAttribute("src");if(s&&s.includes("/blocks/")){const t=e.replace("-frontend-script-js","");(a.has(t)||s.includes(`/blocks/${t}/`))&&i.push({handle:t,src:s.split("?")[0],version:s.includes("ver=")?s.split("ver=")[1]:"1.0.0"})}}}))}return t.querySelectorAll("script:not([src])").forEach((t=>{const e=t.textContent,s=/wp_enqueue_script\s*\(\s*['"]([^'"]+)-frontend-script['"]/g;let n;for(;null!==(n=s.exec(e));){const t=n[1],e="undefined"!=typeof wpOverlay?wpOverlay.template_directory_uri:"";i.push({handle:`${t}-frontend-script`,src:`${e}blocks/${t}/frontend.js`,version:"1.0.0"})}})),i}async setContent(t){this.elements.body.innerHTML=t.content||"",t.scripts&&t.scripts.length>0&&await this.loadDynamicScripts(t.scripts),"undefined"!=typeof wp&&wp.hooks&&wp.hooks.doAction("wpOverlay.contentLoaded",this.elements.body),this.initBlocks()}async loadDynamicScripts(t){const e=t.filter((t=>!this.state.loadedScripts.has(t.handle))).map((t=>this.loadScript(t)));try{await Promise.all(e),this.debug("All scripts loaded successfully")}catch(t){this.debug("Error loading scripts:",t)}}loadScript(t){return new Promise(((e,i)=>{if(this.state.loadedScripts.has(t.handle))return void e();if(document.querySelector(`script[data-handle="${t.handle}"]`))return this.state.loadedScripts.add(t.handle),void e();const s=document.createElement("script");s.src=t.src.includes("?")?t.src:`${t.src}?ver=${t.version}`,s.setAttribute("data-handle",t.handle),s.async=!0,s.onload=()=>{this.debug(`Script loaded: ${t.handle}`),this.state.loadedScripts.add(t.handle),e()},s.onerror=()=>{this.debug(`Script failed to load: ${t.handle}`),i(new Error(`Failed to load ${t.handle}`))},document.head.appendChild(s)}))}initBlocks(){window.wp&&window.wp.blocks,"undefined"!=typeof ScrollAppear&&(new ScrollAppear).processContainer(this.elements.body),this.elements.body.querySelectorAll(".wp-block-gallery").forEach((t=>{})),document.dispatchEvent(new CustomEvent("wpOverlayContentReady",{detail:{container:this.elements.body}}))}showLoading(){this.elements.body.innerHTML=`\n            <div class="${this.config.classes.loading}">\n                <div class="wp-overlay-spinner"></div>\n            </div>\n        `}showError(t){this.elements.body.innerHTML=`\n            <div class="${this.config.classes.error}">\n                <p>⚠️ ${t}</p>\n            </div>\n        `}resetContent(){this.elements.body.innerHTML="",this.state.currentContent=null}debug(...t){this.config.debug}}document.addEventListener("DOMContentLoaded",(()=>{window.wpOverlay=new WPOverlay({debug:!0,scriptLoadTimeout:5e3})}));