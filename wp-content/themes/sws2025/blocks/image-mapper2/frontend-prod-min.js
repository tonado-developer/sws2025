class WordPressImageMapper{constructor(t={}){this.config={selectors:{container:".image-mapper-container",preview:".position-preview",parentImg:".parent_img",marker:".position-marker",overlay:".overlay",checkpoint:".checkpoint-marker",path:".svg-path-container",sideContent:".side-content",personImage:".person-image",illustrationImage:".illustration-image",markerLabel:".markerLabel",zoomBoundaries:".zoom-boundaries",markerDetails:".hotspot-details-container"},classes:{hover:"hover",zoomed:"zoomed",current:"current",open:"open",active:"image-mapper-active",hidden:"element-hidden",IllustrationInitialized:"IllustrationInitialized",IllustrationAnimating:"IllustrationAnimating",IllustrationAnimated:"IllustrationAnimated",animated:"animated"},animation:{zoomDuration:1.5,zoomOutDuration:1.2,ease:"power2.inOut",badgeDelay:1,badgeDuration:5,elementFadeOut:.3,elementFadeIn:.3,overlayPulse:{enabled:!0,duration:2.5,minOpacity:.6,maxOpacity:1,ease:"sine.inOut",stagger:.15}},zoom:{targetViewportHeight:.5,targetViewportWidth:.5,pushRight:1,maxScaleBoost:.3,viewportPadding:.05,topPadding:150},alphaThreshold:10,debug:!1,...t},this.state={initialized:!1,zooming:!1,isPaused:!1,rootContainer:null,currentContainer:null,parentContainer:null,hoveredMarker:null,zoomedMarker:null,zoomLevel:0,zoomHistory:[],zoomTimeline:null,currentlyVisibleElements:new Set,globalElements:null,hasUserInteracted:!1,overlayPulseTimeline:null},this.canvasData=new Map,this.markerZIndices=[],this.markerDetailsCache=new Map,this.markerLabelCache=new Map,this.boundHandlers={containerMouseMove:this.handleContainerMouseMove.bind(this),containerMouseLeave:this.handleContainerMouseLeave.bind(this),containerClick:this.handleContainerClick.bind(this),resize:this.debounce(this.handleResize.bind(this),250),keydown:this.handleKeydown.bind(this)},this.svgPaths=new Map,this.activeCheckpoints=new Set,this.svgUpdateTicker=null,this.init()}init(){if("undefined"==typeof gsap)return this.debug("GSAP not loaded, retrying in 100ms..."),void setTimeout((()=>this.init()),100);const t=document.querySelectorAll(this.config.selectors.container);if(0===t.length)return void this.debug("No image mapper containers found");const e=t[0];this.initContainer(e),this.setupGlobalListeners(),this.observeDOM(),this.state.initialized=!0,this.debug("Image Mapper initialized with root container"),this.startSVGPositioning(),window.wpScrollExtension=new ScrollExtension(this,{mode:"simple-animation",scrollSensitivity:50,virtualScrollHeight:200,enableKeyboardNavigation:!0}),window.scrollDebug={getCurrentPosition:()=>window.wpScrollExtension.getCurrentPosition(),goToMarker:t=>window.wpScrollExtension.navigateToMarkerIndex(t),goToOverview:()=>window.wpScrollExtension.goToOverview(),switchMode:t=>window.wpScrollExtension.setMode(t)}}initBadgePositioning(){this.badgePositions=new Map,this._badgeCalcPending=!1,this._badgeCalcTimeout=null,this._hoveredBadges=new Set;this.state.rootContainer.querySelectorAll(".checkpoint-marker.markerLabel").forEach((t=>{t.addEventListener("mouseenter",(()=>{this.badgePositions.has(t)||this.calculateBadgePosition(t),this._hoveredBadges.add(t),this.applyBadgeTransform(t)})),t.addEventListener("mouseleave",(()=>{this._hoveredBadges.delete(t);const e=t.querySelector(".badgeInfo");e&&(e.style.transform="")}))}));const t=()=>{this._badgeCalcTimeout||0===this.badgePositions.size||document.hidden||(this._badgeCalcTimeout=setTimeout((()=>{document.hidden||(this.badgePositions.forEach(((t,e)=>{this.calculateBadgePosition(e)})),this._hoveredBadges.forEach((t=>{this.applyBadgeTransform(t)}))),this._badgeCalcTimeout=null}),100))};window.addEventListener("scroll",t,{passive:!0}),window.addEventListener("resize",t,{passive:!0}),this._badgeScrollHandler=t;const e=()=>{this.state.zooming&&this._hoveredBadges.size>0&&!this._badgeCalcPending&&!document.hidden&&(this._badgeCalcPending=!0,requestAnimationFrame((()=>{this._hoveredBadges.forEach((t=>{this.calculateBadgePosition(t),this.applyBadgeTransform(t)})),this._badgeCalcPending=!1})))};gsap.ticker.add(e),this._badgeTicker=e}calculateBadgePosition(t){const e=t.querySelector(".badgeInfo");if(!e)return;const s=150,i=10,a=480,o=100;e.style.transform;e.style.transform="",e.offsetHeight;const n=e.getBoundingClientRect(),r=window.innerWidth,l=window.innerHeight;let h={x:0,y:0};n.right>r-o&&(h.x=r-o-n.right),n.left<a&&(h.x=a-n.left),n.bottom>l-i&&(h.y=l-i-n.bottom),n.top<s&&(h.y=s-n.top),this.badgePositions.set(t,h)}applyBadgeTransform(t){const e=this.badgePositions.get(t);if(!e)return;const s=t.querySelector(".badgeInfo");!s||0===e.x&&0===e.y||(s.style.transform=`translate(${e.x}px, ${e.y}px)`)}initContainer(t){const e=t.querySelector(this.config.selectors.preview);if(!e)return void this.debug("No preview element found in container",t);this.state.rootContainer||(this.state.rootContainer=t.closest(this.config.selectors.container)||t,this.debug("Root container set:",this.state.rootContainer)),t.classList.add(this.config.classes.active),this.resetCurrentState(),e.classList.add(this.config.classes.current),this.state.parentContainer=t,this.state.currentContainer=e,0===this.state.zoomLevel&&(this.state.globalElements=this.getGlobalElements()),this.updateVisibleElements(),this.setupIllustrationAnimation(this.state.rootContainer),gsap.set(e,{clearProps:"all"}),this.clearCanvasData();const s=e.querySelectorAll(this.config.selectors.marker),i=e.querySelector(this.config.selectors.parentImg);i?(this.markers=s,this.parent=i,this.setupContainerListeners(t),this.initMarkers(),0!==this.state.zoomLevel||this.markerTransforms||this.precomputeMarkerTransforms(),this.initAllSVGPaths(),this.initBadgePositioning(),0===this.state.zoomLevel&&this.config.animation.overlayPulse.enabled&&!this.state.hasUserInteracted&&this.startOverlayPulse(),this.debug(`Container initialized with ${s.length} markers, ${Object.keys(this.state.globalElements||{}).length} global element types`)):this.debug("No parent image found in preview")}precomputeMarkerTransforms(){if(!this.state.currentContainer||!this.markers)return;this.markerTransforms=new Map;const t={scale:gsap.getProperty(this.state.currentContainer,"scale")||1,x:gsap.getProperty(this.state.currentContainer,"x")||0,y:gsap.getProperty(this.state.currentContainer,"y")||0};gsap.set(this.state.currentContainer,{scale:1,x:0,y:0}),this.markers.forEach((t=>{const e=this.calculateZoomTransform(t);this.markerTransforms.set(t.dataset.hotspotId,{scale:e.scale,translateX:e.translateX,translateY:e.translateY})})),gsap.set(this.state.currentContainer,t),this.debug(`Precomputed transforms for ${this.markerTransforms.size} markers`)}startOverlayPulse(){if(!this.state.currentContainer)return;const t=this.state.currentContainer.querySelectorAll(this.config.selectors.overlay);if(0===t.length)return;const e=this.config.animation.overlayPulse;this.state.overlayPulseTimeline&&this.state.overlayPulseTimeline.kill(),this.state.overlayPulseTimeline=gsap.timeline({repeat:-1}),t.forEach(((t,s)=>{this.state.overlayPulseTimeline.to(t,{opacity:e.minOpacity,duration:e.duration/2,ease:e.ease,yoyo:!0,repeat:1},s*e.stagger)})),this.debug(`Started overlay pulse animation for ${t.length} overlays`)}stopOverlayPulse(){if(this.state.overlayPulseTimeline){const t=this.state.currentContainer?.querySelectorAll(this.config.selectors.overlay);t&&gsap.to(t,{opacity:this.config.animation.overlayPulse.maxOpacity,duration:.3,ease:"power2.out"}),this.state.overlayPulseTimeline.kill(),this.state.overlayPulseTimeline=null,this.debug("Stopped overlay pulse animation")}}getGlobalElements(){if(!this.state.rootContainer)return{};const t={sideContent:[],personImage:[],illustrationImage:[]},e=this.state.rootContainer.querySelectorAll(`${this.config.selectors.sideContent}:not([data-hotspot-id])`),s=this.state.rootContainer.querySelectorAll(`${this.config.selectors.personImage}:not([data-hotspot-id])`),i=this.state.rootContainer.querySelectorAll(`${this.config.selectors.illustrationImage}:not([data-hotspot-id])`);return t.sideContent=Array.from(e),t.personImage=Array.from(s),t.illustrationImage=Array.from(i),t}getRelatedElements(t){if(!t||!this.state.rootContainer)return{};const e=`[data-hotspot-id="${CSS.escape(t.toString())}"]`;return{side:this.state.rootContainer.querySelector(`${this.config.selectors.sideContent}${e}`),person:this.state.rootContainer.querySelector(`${this.config.selectors.personImage}${e}`),illustration:this.state.rootContainer.querySelector(`${this.config.selectors.illustrationImage}${e}`),svgPath:this.state.rootContainer.querySelector(`${this.config.selectors.path}${e}`)}}getAllVisibleRelatedElements(){if(!this.state.rootContainer)return[];const t=[];return[`${this.config.selectors.sideContent}[data-hotspot-id].${this.config.classes.open}`,`${this.config.selectors.personImage}[data-hotspot-id].${this.config.classes.open}`,`${this.config.selectors.illustrationImage}[data-hotspot-id].${this.config.classes.open}`,`${this.config.selectors.path}[data-hotspot-id].${this.config.classes.open}`].forEach((e=>{const s=this.state.rootContainer.querySelectorAll(e);t.push(...Array.from(s))})),t}hideAllElements(t){const e=[];if(this.state.globalElements&&Object.values(this.state.globalElements).forEach((t=>{e.push(...t.filter((t=>t&&t.classList.contains(this.config.classes.open))))})),e.push(...this.getAllVisibleRelatedElements()),0===e.length)return void(t&&t());return gsap.timeline({onComplete:()=>{e.forEach((t=>{t.classList.remove(this.config.classes.open)})),this.state.currentlyVisibleElements.clear(),this.pauseSVGPositioning(),t&&t()}})}showElementsForMarker(t,e,s=null){this.hideAllElements((()=>{const i=this.getRelatedElements(t),a=[];let o=s;if(!o&&this.state.currentContainer){const e=this.state.currentContainer.querySelectorAll(this.config.selectors.marker);o=Array.from(e).find((e=>e.dataset.hotspotId===t))}if(Object.entries(i).forEach((([t,e])=>{if(e){if("svgPath"===t&&(this.initSingleSVGPath(e),o)){const t=()=>{const t=o.getBoundingClientRect(),s=this.state.rootContainer.getBoundingClientRect();e.style.position="absolute",e.style.left=t.left-s.left+"px",e.style.top=t.top-s.top+"px",e.style.width=`${t.width}px`,e.style.height=`${t.height}px`};t(),e._positionUpdateHandler&&gsap.ticker.remove(e._positionUpdateHandler),e._positionUpdateHandler=t,gsap.ticker.add(e._positionUpdateHandler)}a.push(e),e.classList.add(this.config.classes.open),this.state.currentlyVisibleElements.add(e)}})),0===a.length)return void(e&&e());const n=gsap.timeline({onComplete:()=>{a.some((t=>t.classList.contains("svg-path-container")))&&this.startSVGPositioning(),e&&e()}});a.forEach((t=>{n.to(t,{duration:this.config.animation.elementFadeIn,ease:"power2.inOut"},0)}))}))}initAllSVGPaths(){if(!this.state.rootContainer)return;this.state.rootContainer.querySelectorAll(".svg-path-container").forEach((t=>{this.initSingleSVGPath(t)}))}async initSingleSVGPath(t){const e=t.querySelector(".checkpointsWrapper"),s=t.querySelectorAll(".checkpoint-marker"),i=t.dataset.hotspotId;if(!e||0===s.length)return;let a;const o=t.querySelector("svg");if(o){const t=o.querySelector("path");if(!t)return void this.debug("No path found in inline SVG");const e=`inline-${i}`;this.svgPaths.has(e)?a=this.svgPaths.get(e):(a={pathElement:t.cloneNode(!0),viewBox:o.viewBox.baseVal,svgWidth:o.viewBox.baseVal.width||o.width.baseVal.value||100,svgHeight:o.viewBox.baseVal.height||o.height.baseVal.value||100,pathLength:t.getTotalLength(),svgUrl:e},this.svgPaths.set(e,a))}else{const e=t.querySelector(".svg-path");if(!e||!e.src)return;if(a=await this.loadAndCacheSVGPath(e.src,i),!a)return}s.forEach((e=>{if(e._svgContainer=t,e._pathData=a,this.activeCheckpoints.add(e),e.classList.contains("nav-marker")&&null===e.getAttribute("title")){const t="0"===e.dataset.pathPosition?Number(i)-1:Number(i)+1;this.applyCheckpointNavigation(t,e)}})),this.debug(`SVG Path initialized for hotspot ${i}:`,a)}applyCheckpointNavigation(t,e){const s=this.markers[t];s?(e.setAttribute("title","Weiter"),e.addEventListener("click",(t=>{t.stopPropagation(),this.switchToMarker(s)}))):this.debug("Target marker not found for checkpoint navigation:",t)}async loadAndCacheSVGPath(t,e){if(this.svgPaths.has(t))return this.svgPaths.get(t);try{const e=await fetch(t),s=await e.text(),i=document.createElement("div");i.innerHTML=s;const a=i.querySelector("svg"),o=a?.querySelector("path");if(!o)return this.debug("No path found in SVG:",t),null;const n={pathElement:o.cloneNode(!0),viewBox:a.viewBox.baseVal,svgWidth:a.viewBox.baseVal.width||a.width.baseVal.value||100,svgHeight:a.viewBox.baseVal.height||a.height.baseVal.value||100,pathLength:o.getTotalLength(),svgUrl:t};return this.svgPaths.set(t,n),n}catch(t){return this.debug("Error loading SVG path:",t),null}}updateSVGCheckpoints(){this.activeCheckpoints.forEach((t=>{if(!t._svgContainer||!t._pathData)return;const e=t._svgContainer,s=t._pathData;e.classList.contains("open")&&this.positionCheckpointOnPath(t,e,s)}))}positionCheckpointOnPath(t,e,s){const i=parseFloat(t.dataset.pathPosition)||0,a=e.getBoundingClientRect(),o=s.pathElement.getBBox(),n=i/100*s.pathLength,r=s.pathElement.getPointAtLength(n),l=a.width/s.svgWidth,h=a.height/s.svgHeight,c=(r.x-o.x)*l,d=(r.y-o.y)*h;t.style.position="absolute",t.style.left=`${c}px`,t.style.top=`${d}px`}startSVGPositioning(){this.svgUpdateTicker||(this.svgUpdateTicker=()=>{this.activeCheckpoints.size>0&&(this.state.zooming||this.state.currentlyVisibleElements.size>0)&&this.updateSVGCheckpoints()},gsap.ticker.add(this.svgUpdateTicker))}stopSVGPositioning(){this.svgUpdateTicker&&(gsap.ticker.remove(this.svgUpdateTicker),this.svgUpdateTicker=null)}pauseSVGPositioning(){this.svgUpdateTicker&&0===this.activeCheckpoints.size&&!this.state.zooming&&(gsap.ticker.remove(this.svgUpdateTicker),this.svgUpdateTicker=null)}cleanupSVGCheckpoints(t){t.querySelectorAll(".checkpoint-marker").forEach((t=>{this.activeCheckpoints.delete(t),delete t._svgContainer,delete t._pathData}))}updateVisibleElements(){this.state.currentlyVisibleElements.clear(),this.state.globalElements&&Object.values(this.state.globalElements).forEach((t=>{t.forEach((t=>{t&&t.classList.contains(this.config.classes.open)&&this.state.currentlyVisibleElements.add(t)}))})),this.getAllVisibleRelatedElements().forEach((t=>{this.state.currentlyVisibleElements.add(t)}))}illustrationAnimationTypes(){return{"fluegel.svg":{init:t=>{const e=t.querySelectorAll("path");if(2==e.length)return gsap.set(t,{opacity:1}),t.style.display="flex",e.forEach((t=>{gsap.set(e,{scale:0,opacity:.6,transformOrigin:t=>0===t?"right bottom":"left bottom"})})),t},fadeIn:(t,e)=>{const s=t.querySelectorAll("path");if(2==s.length)return s.forEach(((t,s)=>{const i=.1*s+.1*Math.random();gsap.to(t,{scale:1,duration:1.5,ease:"back.out(1.7)",stagger:.1,opacity:1,delay:i,onComplete:()=>{const i=0===s?-1:1,a=2*Math.random()-1;gsap.to(t,{rotation:(8+a)*i,transformOrigin:0===s?"right bottom":"left bottom",duration:1.2,ease:"sine.inOut",repeat:-1,yoyo:!0}),e&&e()}})})),t},fadeOut:t=>{const e=t.querySelectorAll("path");gsap.killTweensOf(e),gsap.to(e,{scale:0,opacity:0,duration:.8,ease:"power2.in",onComplete:()=>{t.style.display="none",gsap.set(t,{opacity:0})}})}},"fluegel_mobile.svg":{init:t=>{const e=t.querySelectorAll("path");if(2==e.length)return gsap.set(t,{opacity:1}),t.style.display="flex",e.forEach((t=>{gsap.set(e,{scale:0,opacity:.6,transformOrigin:t=>0===t?"right bottom":"left bottom"})})),t},fadeIn:(t,e)=>{const s=t.querySelectorAll("path");if(2==s.length)return s.forEach(((t,s)=>{const i=.1*s+.1*Math.random();gsap.to(t,{scale:1,duration:1.5,ease:"back.out(1.7)",stagger:.1,opacity:1,delay:i,onComplete:()=>{const i=0===s?-1:1,a=2*Math.random()-1;gsap.to(t,{rotation:(8+a)*i,transformOrigin:0===s?"right bottom":"left bottom",duration:1.2,ease:"sine.inOut",repeat:-1,yoyo:!0}),e&&e()}})})),t},fadeOut:t=>{const e=t.querySelectorAll("path");gsap.killTweensOf(e),gsap.to(e,{scale:0,opacity:0,duration:.8,ease:"power2.in",onComplete:()=>{t.style.display="none",gsap.set(t,{opacity:0})}})}},"illu_feuer.svg":{init:t=>{const e=t.querySelectorAll("path");if(!(e.length<1))return gsap.set(t,{opacity:1}),t.style.display="flex",e.forEach((t=>{gsap.set(t,{scale:.8,opacity:0,transformOrigin:"center bottom",x:0,y:0,rotation:0})})),t},fadeIn:(t,e)=>{const s=t.querySelectorAll("path");if(!(s.length<1))return s.forEach(((t,i)=>{const a=.3*i;gsap.to(t,{scale:1,opacity:1,duration:1.5,ease:"power2.out",delay:a,onComplete:()=>{gsap.timeline({repeat:-1}).to(t,{scale:.96+.08*Math.random(),opacity:.88+.12*Math.random(),rotation:2*Math.random()-1,x:-.5+Math.random(),y:-.5+Math.random(),duration:.8+.4*Math.random(),ease:"sine.inOut"}).to(t,{scale:.97+.06*Math.random(),opacity:.9+.1*Math.random(),rotation:-.5+Math.random(),x:.6*Math.random()-.3,y:.6*Math.random()-.3,duration:.9+.4*Math.random(),ease:"sine.inOut"}),gsap.to(t,{y:2*i-6,rotation:4*Math.random()-2,duration:3+1*Math.random(),ease:"sine.inOut",repeat:-1,yoyo:!0}),i===s.length-1&&e&&e()}})})),t},fadeOut:t=>{const e=t.querySelectorAll("path");gsap.killTweensOf(e),gsap.to(e,{scale:.7,opacity:0,rotation:0,x:0,y:0,duration:.8,ease:"power2.in",stagger:.2,onComplete:()=>{t.style.display="none",gsap.set(t,{opacity:0})}})}},"illu_helm.svg":{init:t=>{const e=t.querySelectorAll("path");if(2!==e.length)return;const s=e[0],i=e[1];return gsap.set(t,{opacity:1}),t.style.display="flex",gsap.set(s,{y:-200,rotation:-15,opacity:1,transformOrigin:"center top"}),gsap.set(i,{scaleY:0,opacity:0,transformOrigin:"top center"}),t},fadeIn:(t,e)=>{const s=t.querySelectorAll("path");if(2!==s.length)return;const i=s[0],a=s[1];return gsap.to(i,{y:0,rotation:0,duration:1.2,ease:"power2.out",onComplete:()=>{gsap.to(a,{scaleY:1,opacity:1,duration:1.5,ease:"power2.out",onComplete:()=>{e&&e()}})}}),t},fadeOut:t=>{const e=t.querySelectorAll("path");if(2!==e.length)return;const s=e[0],i=e[1];gsap.killTweensOf([s,i]),gsap.to([s,i],{y:-50,scale:.8,opacity:0,duration:.8,ease:"power2.in",onComplete:()=>{t.style.display="none",gsap.set(t,{opacity:0})}})}},"illu_striche.svg":{init:t=>{const e=t.querySelectorAll("path");if(0!==e.length)return gsap.set(t,{opacity:1}),t.style.display="flex",e.forEach((t=>{gsap.set(t,{scale:0,opacity:0,transformOrigin:"center center"})})),t},fadeIn:(t,e)=>{const s=t.querySelectorAll("path");if(0!==s.length)return s.forEach(((t,i)=>{const a=.05*i;gsap.to(t,{scale:1,opacity:1,duration:.8,ease:"back.out(1.2)",delay:a,onComplete:()=>{gsap.to(t,{scale:1.02,duration:2+.5*Math.random(),ease:"sine.inOut",repeat:-1,yoyo:!0}),i===s.length-1&&e&&e()}})})),t},fadeOut:t=>{const e=t.querySelectorAll("path");gsap.killTweensOf(e),gsap.to(e,{scale:0,opacity:0,duration:.6,ease:"power2.in",stagger:.03,onComplete:()=>{t.style.display="none",gsap.set(t,{opacity:0})}})}}}}setupIllustrationAnimation(t){const e=t.querySelectorAll(`${this.config.selectors.illustrationImage}.open`);if(!e||0==e.length)return;const s=this.illustrationAnimationTypes(),i=[];e.forEach((t=>{const e=t.dataset.originalFile.split("/").pop()||"fluegel.svg";if(e&&s[e]){let a=s[e].init(t);a&&(i.push({element:a,type:e}),t.classList.add(this.config.classes.IllustrationInitialized))}})),i.forEach((({element:t,type:e})=>{t.classList.add(this.config.classes.IllustrationAnimating),s[e].fadeIn(t,(()=>{t.classList.remove(this.config.classes.IllustrationAnimating),t.classList.add(this.config.classes.IllustrationAnimated)}))}))}resetIllustrationAnimation(){const t=this.state.rootContainer;if(!t)return;const e=t.querySelectorAll(`.${this.config.classes.IllustrationInitialized}`);if(!e||0==e.length)return;const s=this.illustrationAnimationTypes();e.forEach((t=>{const e=t.dataset.originalFile.split("/").pop()||"fluegel.svg";s[e].fadeOut(t)}))}setupContainerListeners(t){this.removeContainerListeners(t),t.addEventListener("mousemove",this.boundHandlers.containerMouseMove,{passive:!0}),t.addEventListener("mouseleave",this.boundHandlers.containerMouseLeave,{passive:!0}),t.addEventListener("click",this.boundHandlers.containerClick,{capture:!0}),t._mapperListeners=!0}removeContainerListeners(t){t._mapperListeners&&(t.removeEventListener("mousemove",this.boundHandlers.containerMouseMove),t.removeEventListener("mouseleave",this.boundHandlers.containerMouseLeave),t.removeEventListener("click",this.boundHandlers.containerClick),delete t._mapperListeners)}initMarkers(){this.markerZIndices=[],this.markerDetailsCache.clear(),this.markerLabelCache.clear(),this.markers.forEach(((t,e)=>{const s=t.querySelector(`${this.config.selectors.overlay} img`);if(!s)return void this.debug(`No overlay found for marker ${e}`);const i=parseInt(window.getComputedStyle(t).zIndex)||0;if(this.markerZIndices.push({marker:t,zIndex:i,index:e}),this.state.rootContainer){const t=this.state.rootContainer.querySelector(`${this.config.selectors.markerDetails}[data-hotspot-id="${e}"]`);if(t){this.markerDetailsCache.set(e,t);const s=t.querySelector(`${this.config.selectors.markerLabel} h3.badge`);s&&this.markerLabelCache.set(e,s)}}this.setupMarkerCanvas(s,e),this.attachMarkerEvents(t)})),this.markerZIndices.sort(((t,e)=>e.zIndex-t.zIndex))}setupMarkerCanvas(t,e){const s=document.createElement("canvas"),i=s.getContext("2d",{willReadFrequently:!0}),a=()=>{s.width=t.naturalWidth,s.height=t.naturalHeight;try{i.drawImage(t,0,0);const a=i.getImageData(0,0,s.width,s.height);this.canvasData.set(e,{imageData:a,width:s.width,height:s.height,img:t.getBoundingClientRect()}),this.setupmarkerLabel(e)}catch(t){this.debug("Canvas CORS issue for marker",e,t.message),this.canvasData.set(e,null),this.setupmarkerLabel(e)}};t.complete&&t.naturalWidth>0?a():(t.addEventListener("load",a,{once:!0}),t.addEventListener("error",(()=>{this.debug("Failed to load overlay:",t.src),this.canvasData.set(e,null),this.setupmarkerLabel(e)}),{once:!0}))}setupmarkerLabel(t){const e=this.state.rootContainer.querySelector(`${this.config.selectors.markerDetails}[data-hotspot-id="${t}"]`).querySelector(`${this.config.selectors.markerLabel}`);if(!e)return;const s=this.canvasData.get(t);if(!s)return e.style.left="50%",void(!e.classList.contains("animated")&&this.animateMarkerSequence(e,t));const{imageData:i,width:a,height:o,img:n}=s,r=i.data;for(let s=0;s<o;s++)for(let i=0;i<a;i++){if(r[4*(s*a+i)+3]>0)return e.style.left=`${n.left+i/a*n.width}px`,e.style.top=`${n.top}px`,void(!e.classList.contains("animated")&&this.animateMarkerSequence(e,t))}}animateMarkerSequence(t,e){const s=t.querySelector(".badge"),i=t.querySelector(".string"),a=s.textContent;gsap.set(t,{opacity:0}),gsap.set(i,{scaleY:0,transformOrigin:"bottom"}),gsap.set(s,{opacity:0,y:10}),s.textContent="";const o=gsap.timeline(),n=this.config.animation.badgeDuration,r=this.config.animation.badgeDelay;o.to(t,{opacity:1,delay:.5,duration:n/5,onComplete:()=>{t.classList.add(this.config.classes.animated)}}).to(i,{scaleY:1,duration:n/2.25,ease:"power2.in",delay:e*r}).add((()=>this.typewriterEffect(s,a))).to(s,{opacity:1,y:0})}typewriterEffect(t,e){let s=0;const i=.4*this.config.animation.badgeDuration*1e3/e.length;t.textContent=e.substring(0,s+1),s++;const a=setInterval((()=>{t.textContent=e.substring(0,s+1),s++,s>=e.length&&clearInterval(a)}),i)}attachMarkerEvents(t){this.detachMarkerEvents(t),t._handlers={enter:()=>this.handleMarkerEnter(t),leave:()=>this.handleMarkerLeave(t)},t.addEventListener("mouseenter",t._handlers.enter,{passive:!0}),t.addEventListener("mouseleave",t._handlers.leave,{passive:!0})}detachMarkerEvents(t){t._handlers&&(t.removeEventListener("mouseenter",t._handlers.enter),t.removeEventListener("mouseleave",t._handlers.leave),delete t._handlers)}handleMarkerEnter(t){this.state.hoveredMarker&&this.state.hoveredMarker!==t&&this.setHoverState(this.state.hoveredMarker,!1),this.state.hoveredMarker=t}handleMarkerLeave(t){this.setHoverState(t,!1),this.state.hoveredMarker===t&&(this.state.hoveredMarker=null)}findMarkerAtPosition(t){if(!this.markers)return null;for(const{marker:e,index:s}of this.markerZIndices){const i=this.markerLabelCache.get(s);if(i){const s=i.getBoundingClientRect();if(t.clientX>=s.left&&t.clientX<=s.right&&t.clientY>=s.top&&t.clientY<=s.bottom)return e}}for(const{marker:e,index:s}of this.markerZIndices){const i=e.querySelector(this.config.selectors.overlay);if(!i)continue;const a=e.getBoundingClientRect();if(t.clientX>=a.left&&t.clientX<=a.right&&t.clientY>=a.top&&t.clientY<=a.bottom){const o=this.canvasData.get(s);if(!o||!o.imageData)return e;{const s=o.width/i.offsetWidth,n=o.height/i.offsetHeight,r=Math.floor((t.clientX-a.left)*s),l=Math.floor((t.clientY-a.top)*n);if(this.isPixelOpaque(o.imageData,r,l))return e}}}return null}handleContainerMouseMove(t){if(!this.markers||this.state.zooming||this.state.isPaused)return;this.markers.forEach((t=>this.setHoverState(t,!1)));const e=this.findMarkerAtPosition(t);e&&(this.state.hasUserInteracted||(this.state.hasUserInteracted=!0,this.stopOverlayPulse()),this.setHoverState(e,!0))}handleContainerMouseLeave(t){this.markers&&(this.markers.forEach((t=>this.setHoverState(t,!1))),this.state.hoveredMarker=null,this.state.parentContainer&&(this.state.parentContainer.style.cursor=""))}isPixelOpaque(t,e,s){if(e<0||s<0||e>=t.width||s>=t.height)return!1;const i=4*(s*t.width+e)+3;return t.data[i]>this.config.alphaThreshold}setHoverState(t,e){e?(t.classList.add(this.config.classes.hover),this.state.parentContainer&&(this.state.parentContainer.style.cursor="pointer")):(t.classList.remove(this.config.classes.hover),this.state.parentContainer&&(this.state.parentContainer.style.cursor=""))}handleContainerClick(t){if(!this.state.currentContainer||this.state.zooming||this.state.isPaused)return;this.state.hasUserInteracted||(this.state.hasUserInteracted=!0,this.stopOverlayPulse());const e=this.state.currentContainer.getBoundingClientRect();if(t.clientX<e.left||t.clientX>e.right||t.clientY<e.top||t.clientY>e.bottom)return;const s=this.findMarkerAtPosition(t);if(s){t.preventDefault(),t.stopPropagation();const e=s.getAttribute("href");if(e&&"#"!==e)return void(window.location.href=e);s.classList.contains(this.config.classes.zoomed)||(this.zoomToMarker(s),window.wpScrollExtension&&!this._isCalledFromScroll&&setTimeout((()=>{window.wpScrollExtension.syncWithClickedMarker(s)}),50))}}zoomToMarker(t,e=!1){if(this.state.zooming)return;this.state.zooming=!0,this.resetIllustrationAnimation(),this._isCalledFromScroll=e,this.state.zoomTimeline&&this.state.zoomTimeline.kill();const s=t.dataset.hotspotId;this.state.zoomHistory.push({parent:this.state.parentContainer,container:this.state.currentContainer,marker:t,originalParentSrc:this.parent.src}),this.state.zoomLevel++,this.state.zoomedMarker=t;const i=this.calculateZoomTransform(t);this.state.currentContainer.classList.add(this.config.classes.zoomed),t.classList.add(this.config.classes.zoomed);this.state.rootContainer.classList.add(this.config.classes.zoomed),this.setHoverState(t,!1),this.markers.forEach((t=>this.detachMarkerEvents(t))),this.animateZoomIn(i,t,s),window.scrollExtension&&window.scrollExtension.syncWithManualZoom&&window.scrollExtension.syncWithManualZoom(t)}switchToMarker(t){if(this.state.zooming||!t)return;const e=this.state.zoomedMarker?.dataset.hotspotId,s=t.dataset.hotspotId;if(e===s)return;this.resetIllustrationAnimation(),this.cleanupPreviousMarker(),this.state.zooming=!0,this.state.zoomTimeline&&this.state.zoomTimeline.kill();const i=this.state.zoomedMarker;this.state.zoomedMarker=t,i&&i.classList.remove(this.config.classes.zoomed),t.classList.add(this.config.classes.zoomed);const a=this.state.zoomHistory[this.state.zoomHistory.length-1];this.state.currentContainer=a.container;const o=t.querySelector(this.config.selectors.preview)?.querySelector(this.config.selectors.parentImg);let n;this.state.parentContainer=a.parent,this.parent=o,this.markers=this.state.currentContainer.querySelectorAll(this.config.selectors.marker),this.state.zoomHistory.length>0&&(this.state.zoomHistory[this.state.zoomHistory.length-1].marker=t),this.state.zoomedMarker=t,this.markerTransforms&&this.markerTransforms.has(s)?(n=this.markerTransforms.get(s),this.debug(`Using precomputed transform for marker ${s}`)):(this.debug(`No precomputed transform for marker ${s}, calculating...`),n=this.calculateZoomTransform(t)),i&&this.setHoverState(i,!1),this.markers&&this.markers.forEach((t=>this.detachMarkerEvents(t)));const r=gsap.timeline({onComplete:()=>{this.state.zooming=!1;const e=this.state.rootContainer;this.onZoomComplete(t),this.state.rootContainer=e}});r.add((()=>{this.hideAllElements((()=>{s&&requestAnimationFrame((()=>{this.showElementsForMarker(s,null,t)}))}))}),0),r.to(this.state.currentContainer,{duration:.8*this.config.animation.zoomDuration,scale:n.scale,x:n.translateX,y:n.translateY,transformOrigin:"center center",ease:this.config.animation.ease},0),this.state.zoomTimeline=r}cleanupPreviousMarker(){const t=this.state.rootContainer?.querySelectorAll(".svg-path-container:not(.open)");t&&t.forEach((t=>{t._positionUpdateHandler&&(gsap.ticker.remove(t._positionUpdateHandler),delete t._positionUpdateHandler)})),this.activeCheckpoints.forEach((t=>{t._svgContainer?.classList.contains("open")||(this.activeCheckpoints.delete(t),delete t._svgContainer,delete t._pathData)}))}animateZoomIn(t,e,s){const i=gsap.timeline({onComplete:()=>{this.state.zooming=!1,this.onZoomComplete(e)}});this.hideAllElements((()=>{s&&this.showElementsForMarker(s)})),i.to(this.state.currentContainer,{duration:this.config.animation.zoomDuration,scale:t.scale,x:t.translateX,y:t.translateY,transformOrigin:"center center",ease:this.config.animation.ease},0),i.add((()=>this.addBackButton()),.5),this.state.zoomTimeline=i}onZoomComplete(t){if(t.querySelector(this.config.selectors.preview)){const e=this.state.rootContainer;this.initContainer(t),this.state.rootContainer=e}}calculateZoomTransform(t){const e=this.state.rootContainer.querySelector(this.config.selectors.zoomBoundaries),s=window.getComputedStyle(e),i={top:parseFloat(s.paddingTop),right:parseFloat(s.paddingRight),bottom:parseFloat(s.paddingBottom),left:parseFloat(s.paddingLeft)},a={width:window.innerWidth-i.left-i.right,height:window.innerHeight-i.top-i.bottom,centerX:i.left+(window.innerWidth-i.left-i.right)/2,centerY:i.top+(window.innerHeight-i.top-i.bottom)/2},o=this.state.currentContainer,n=o.getBoundingClientRect(),r=t.getBoundingClientRect(),l=(this.state.currentContainer.querySelector('.parent_img:not([style*="display: none"])')||this.parent).getBoundingClientRect(),h=o.closest(".position-prezoom");let c=1;if(h){const t=window.getComputedStyle(h).transform;if(t&&"none"!==t){c=new DOMMatrix(t).a}}const d=n.left+n.width/2,m=n.top+n.height/2,u=r.left+r.width/2,p=r.top+r.height/2;let g=Math.max(a.height/r.height,a.width/r.width);let f=a.centerX-d-(u-d)*g,v=a.centerY-m-(p-m)*g;const y=this.calculateBoundaryConstraints(l,n,g,f,v,i,a);return{scale:y.scale,translateX:y.x,translateY:y.y}}calculateBoundaryConstraints(t,e,s,i,a,o,n){const r={x:t.width*(s-1)/2,y:t.height*(s-1)/2};i=Math.max(-r.x,Math.min(r.x,i)),a=Math.max(-r.y,Math.min(r.y,a));const l=t.width*s,h=t.height*s,c=t.left-e.left,d=t.top-e.top,m=n.centerX+i,u=n.centerY+a,p={left:m+c*s-e.width*s/2,top:u+d*s-e.height*s/2};p.right=p.left+l,p.bottom=p.top+h;const g=o.left,f=o.top,v=window.innerWidth-o.right,y=window.innerHeight-o.bottom;if(p.left>g){const t=(p.left-g)/s;i=Math.max(-r.x,i-t)}if(p.right<v){const t=(v-p.right)/s;i=Math.min(r.x,i+t)}if(p.top>f){const t=(p.top-f)/s;a=Math.max(-r.y,a-t)}if(p.bottom<y){const t=(y-p.bottom)/s;a=Math.min(r.y,a+t)}return{x:i,y:a,scale:s}}zoomOut(){if(0===this.state.zoomHistory.length||this.state.zooming)return;this.state.zooming=!0;const t=this.state.zoomHistory.pop();if(this.state.zoomLevel--,this.state.zoomedMarker=null,window.wpScrollExtension)if(t.marker&&this.state.zoomHistory.length>0){const t=this.state.zoomHistory[this.state.zoomHistory.length-1],e=t.container?.querySelectorAll(this.config.selectors.marker);if(e){const s=Array.from(e).findIndex((e=>e===t.marker));window.wpScrollExtension.state.currentMarkerIndex=s}}else window.wpScrollExtension.state.currentMarkerIndex=-1;this.state.zoomTimeline&&this.state.zoomTimeline.kill(),this.hideAllElements((()=>{0===this.state.zoomLevel&&(this.state.globalElements=this.getGlobalElements(),this.state.globalElements&&Object.values(this.state.globalElements).forEach((t=>{t.forEach((t=>{t&&t.classList.add(this.config.classes.open)}))})))})),this.animateZoomOut(t)}resetToOverview(){this.state.currentMarkerIndex=-1,this.state.isNavigating=!1}animateZoomOut(t){const e=gsap.timeline({onComplete:()=>{this.state.zooming=!1,this.state.zoomTimeline=null,this.onZoomOutComplete(t)}});e.to(t.container,{duration:this.config.animation.zoomOutDuration,scale:1,x:0,y:0,ease:this.config.animation.ease,onComplete:()=>{gsap.set(t.container,{clearProps:"all"});this.state.rootContainer.classList.remove(this.config.classes.zoomed)}}),e.add((()=>{t.container.classList.remove(this.config.classes.zoomed),t.marker.classList.remove(this.config.classes.zoomed),0===this.state.zoomHistory.length&&this.removeBackButton()}),.5*this.config.animation.zoomOutDuration),this.state.zoomTimeline=e}onZoomOutComplete(t){this.state.parentContainer=t.parent,this.state.currentContainer=t.container,setTimeout((()=>{const e=t.parent||t.container.closest(this.config.selectors.container);if(e){const t=this.state.rootContainer;this.initContainer(e),this.state.rootContainer=t,this.markers&&this.markers.forEach(((t,e)=>{this.attachMarkerEvents(t);const s=t.querySelector(this.config.selectors.overlay);s&&s.complete&&s.naturalWidth>0&&this.setupMarkerCanvas(t,s,e)})),window.wpScrollExtension&&(window.wpScrollExtension.refreshMarkers(),window.wpScrollExtension.state.currentMarkerIndex=-1),this.debug("Zoom-out complete, container re-initialized")}}),100)}getRelatedElementsFromContainer(t,e){const s=this.state.rootContainer||e;if(!t||!s)return{};const i=`[data-hotspot-id="${CSS.escape(t.toString())}"]`;return{side:s.querySelector(`${this.config.selectors.sideContent}${i}`),person:s.querySelector(`${this.config.selectors.personImage}${i}`),illustration:s.querySelector(`${this.config.selectors.illustrationImage}${i}`),svgPath:s.querySelector(`${this.config.selectors.path}${i}`)}}addBackButton(){this.removeBackButton();const t=document.createElement("button");t.className="zoom-back-btn",t.textContent="Zurück",t.addEventListener("click",(t=>{t.stopPropagation(),window.wpScrollExtension&&window.wpScrollExtension.syncWithMapperState(),this.zoomOut()}));this.state.rootContainer.appendChild(t)}removeBackButton(){document.querySelectorAll(".zoom-back-btn").forEach((t=>t.remove()))}setupGlobalListeners(){window.addEventListener("resize",this.boundHandlers.resize,{passive:!0}),document.addEventListener("keydown",this.boundHandlers.keydown),this.boundHandlers.visibilityChange=()=>{document.hidden?this.pauseOperations():this.resumeOperations()},document.addEventListener("visibilitychange",this.boundHandlers.visibilityChange)}pauseOperations(){this.state.isPaused=!0,this.pauseSVGPositioning(),this.debug("Operations paused (tab hidden)")}resumeOperations(){this.state.isPaused=!1,(this.state.currentlyVisibleElements.size>0||this.state.zooming)&&this.startSVGPositioning(),this.debug("Operations resumed (tab visible)")}handleKeydown(t){"Escape"===t.key&&this.state.zoomLevel>0&&(t.preventDefault(),this.zoomOut())}handleResize(){this.state.zoomLevel>0&&this.state.zoomedMarker,this.markers.forEach(((t,e)=>{const s=t.querySelector(this.config.selectors.overlay);s&&this.setupMarkerCanvas(s,e)}))}observeDOM(){"undefined"!=typeof MutationObserver&&(this.observer=new MutationObserver((t=>{t.forEach((t=>{t.addedNodes.forEach((t=>{if(1===t.nodeType&&t.matches)if(!this.state.rootContainer&&t.matches(this.config.selectors.container))this.initContainer(t);else if(t.querySelector){const e=t.querySelectorAll(this.config.selectors.container);!this.state.rootContainer&&e.length>0&&this.initContainer(e[0])}}))}))})),this.observer.observe(document.body,{childList:!0,subtree:!0}))}resetCurrentState(){document.querySelectorAll(this.config.selectors.preview).forEach((t=>t.classList.remove(this.config.classes.current)))}clearCanvasData(){this.canvasData.clear(),this.markerZIndices=[]}debounce(t,e){let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>t.apply(this,i)),e)}}destroy(){this.state.zoomTimeline&&this.state.zoomTimeline.kill(),this.stopSVGPositioning(),this.activeCheckpoints.clear(),this.svgPaths.clear(),document.querySelectorAll(this.config.selectors.container).forEach((t=>{this.removeContainerListeners(t),t.classList.remove(this.config.classes.active),t.style.cursor=""})),window.removeEventListener("resize",this.boundHandlers.resize),document.removeEventListener("keydown",this.boundHandlers.keydown),this.boundHandlers.visibilityChange&&document.removeEventListener("visibilitychange",this.boundHandlers.visibilityChange),this._badgeScrollHandler&&(window.removeEventListener("scroll",this._badgeScrollHandler),window.removeEventListener("resize",this._badgeScrollHandler)),this.markers&&this.markers.forEach((t=>this.detachMarkerEvents(t))),this.removeBackButton(),this.state.currentContainer&&gsap.set(this.state.currentContainer,{clearProps:"all"}),this.observer&&this.observer.disconnect(),this.clearCanvasData(),this.markerDetailsCache.clear(),this.markerLabelCache.clear(),this.state.rootContainer=null,this.state.parentContainer=null,this.state.currentContainer=null,this.state.globalElements=null,this.state.currentlyVisibleElements.clear(),this.state.isPaused=!1,this._badgeTicker&&(gsap.ticker.remove(this._badgeTicker),this._badgeTicker=null),this._badgeCalcTimeout&&(clearTimeout(this._badgeCalcTimeout),this._badgeCalcTimeout=null),this.markerTransforms=null,this.debug("Image Mapper destroyed")}refresh(){this.debug("Refreshing Image Mapper...");this.state.rootContainer;this.destroy(),this.state.rootContainer=null,this.init()}debug(t,e){this.config.debug}}document.addEventListener("DOMContentLoaded",(()=>{window.wpImageMapper=new WordPressImageMapper({zoom:{targetViewportHeight:.6,targetViewportWidth:.9,pushRight:3,maxScaleBoost:.8,viewportPadding:.3,topPadding:200},animation:{zoomDuration:1.5,zoomOutDuration:1.2,ease:"power2.inOut",badgeDelay:.4,badgeDuration:1.5,elementFadeOut:.3,elementFadeIn:.3},alphaThreshold:10,debug:!1}),"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0||(window.scrollExtension=new ScrollExtension(window.wpImageMapper,{mode:"simple-animation",scrollSensitivity:100,enableKeyboardNavigation:!0}))}));class ScrollExtension{constructor(t,e={}){this.mapper=t,this.config={mode:"simple-animation",scrollSensitivity:100,virtualScrollHeight:400,autoPlayDelay:0,enableKeyboardNavigation:!0,...e},this.state={isScrolling:!1,currentMarkerIndex:-1,scrollProgress:0,virtualScroll:0,markers:[],isAutoPlaying:!1,initialized:!1,isNavigating:!1},this.init()}init(){this.collectMarkers(),0!==this.state.markers.length&&("live-scroll"===this.config.mode?this.initLiveScroll():this.initSimpleAnimation(),this.config.enableKeyboardNavigation&&this.setupKeyboardNavigation(),this.state.initialized=!0)}collectMarkers(){const t=[],e=this.mapper.markers;e&&e.forEach(((e,s)=>{e.dataset.hotspotId||(e.dataset.hotspotId=s.toString()),t.push({element:e,level:0,parent:null,index:s,id:e.dataset.hotspotId})})),this.state.markers=t}initSimpleAnimation(){let t=0,e=0,s=!1;const i=i=>{if(this.isOverlayOpen())return;if(i.preventDefault(),this.mapper.state.zooming||this.state.isNavigating)return;const a=Date.now(),o=a-e;o>500&&(t=0),t+=i.deltaY,e=a,!s&&Math.abs(t)>this.config.scrollSensitivity&&o>100&&(s=!0,requestAnimationFrame((()=>{t>0?this.nextMarker():this.previousMarker(),t=0,s=!1})))};window.addEventListener("wheel",i,{passive:!1}),this._wheelHandler=i}syncWithManualZoom(t){const e=this.state.markers.findIndex((e=>e.element===t));-1!==e&&(this.state.currentMarkerIndex=e)}setupKeyboardNavigation(){const t=t=>{if(!this.isOverlayOpen()&&!this.mapper.state.zooming)switch(t.key){case"ArrowDown":case"ArrowRight":t.preventDefault(),this.nextMarker();break;case"ArrowUp":case"ArrowLeft":t.preventDefault(),this.previousMarker();break;case"Home":t.preventDefault(),this.goToStart();break;case"End":t.preventDefault(),this.goToEnd();break}};document.addEventListener("keydown",t),this._keydownHandler=t}setupTouchScroll(){let t=0,e=0;const s=s=>{this.isOverlayOpen()||(t=s.touches[0].clientY,e=0)},i=s=>{if(this.isOverlayOpen())return;if(this.mapper.state.zooming)return;const i=s.touches[0].clientY;e+=t-i,t=i,Math.abs(e)>this.config.scrollSensitivity/2&&(e>0?this.nextMarker():this.previousMarker(),e=0)};window.addEventListener("touchstart",s,{passive:!0}),window.addEventListener("touchmove",i,{passive:!1}),this._touchStartHandler=s,this._touchMoveHandler=i}nextMarker(){if(this.isOverlayOpen())return;if(this.mapper.state.zooming)return;const t=this.state.currentMarkerIndex+1;t<this.state.markers.length&&this.navigateToMarkerIndex(t)}previousMarker(){if(this.isOverlayOpen())return;if(this.mapper.state.zooming)return;const t=this.state.currentMarkerIndex-1;t>=-1&&(-1===t?this.goToOverview():this.navigateToMarkerIndex(t))}navigateToMarkerIndex(t){if(t<0||t>=this.state.markers.length)return;const e=this.state.currentMarkerIndex,s=this.state.markers[t];this.state.currentMarkerIndex=t,-1===e?this.mapper.zoomToMarker(s.element,!0):this.mapper.switchToMarker(s.element)}goToOverview(){this.mapper.state.zooming||(this.state.currentMarkerIndex=-1,this.mapper.state.zoomLevel>0&&this.mapper.zoomOut())}goToStart(){0!==this.state.markers.length&&this.navigateToMarkerIndex(0)}goToEnd(){0!==this.state.markers.length&&this.navigateToMarkerIndex(this.state.markers.length-1)}getCurrentPosition(){return{currentIndex:this.state.currentMarkerIndex,totalMarkers:this.state.markers.length,isInOverview:-1===this.state.currentMarkerIndex,progress:-1===this.state.currentMarkerIndex?0:(this.state.currentMarkerIndex+1)/this.state.markers.length}}initLiveScroll(){"undefined"!=typeof ScrollTrigger?(gsap.registerPlugin(ScrollTrigger),this.createVirtualScroll(),this.setupScrollTimeline()):this.loadScrollTrigger((()=>this.initLiveScroll()))}createVirtualScroll(){const t=document.querySelector(".virtual-scroll-container");t&&t.remove();const e=document.createElement("div");e.className="virtual-scroll-container";const s=this.state.markers.length*this.config.virtualScrollHeight;e.style.cssText=`\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 1px;\n            height: ${s}vh;\n            pointer-events: none;\n            visibility: hidden;\n        `,document.body.appendChild(e),document.body.style.overflow="auto",document.body.style.height="auto",document.documentElement.style.overflow="auto",this.virtualScrollContainer=e}refreshMarkers(){this.state.currentMarkerIndex;this.collectMarkers(),this.syncWithMapperState()}syncWithMapperState(){if(0===this.mapper.state.zoomLevel)this.state.currentMarkerIndex=-1;else if(this.mapper.state.zoomedMarker){const t=this.state.markers.findIndex((t=>t.element===this.mapper.state.zoomedMarker));-1!==t&&(this.state.currentMarkerIndex=t)}}setupScrollTimeline(){this.scrollTimeline&&this.scrollTimeline.kill();const t=gsap.timeline({scrollTrigger:{trigger:this.virtualScrollContainer,start:"top top",end:"bottom bottom",scrub:1,markers:!1,onUpdate:t=>{this.handleScrollProgress(t.progress)}}});this.state.markers.forEach(((e,s)=>{const i=s,a=gsap.timeline();a.to(this.mapper.state.currentContainer,{duration:1,scale:()=>this.mapper.calculateZoomTransform(e.element).scale,x:()=>this.mapper.calculateZoomTransform(e.element).translateX,y:()=>this.mapper.calculateZoomTransform(e.element).translateY,ease:"none",onStart:()=>{this.prepareMarkerZoom(e,s)},onComplete:()=>{this.completeMarkerZoom(e,s)}}),t.add(a,i)})),this.scrollTimeline=t}handleScrollProgress(t){this.state.scrollProgress=t;const e=Math.min(Math.floor(t*this.state.markers.length),this.state.markers.length-1);e!==this.state.currentMarkerIndex&&e>=0&&(this.state.currentMarkerIndex=e)}prepareMarkerZoom(t,e){this.state.currentMarkerIndex=e,t.element.classList.add("scroll-target")}completeMarkerZoom(t,e){this.mapper.state.zoomedMarker=t.element,this.mapper.state.zoomLevel=t.level+1;const s=t.element.dataset.hotspotId;s&&this.mapper.showElementsForMarker(s,null,t.element),t.element.classList.remove("scroll-target")}isOverlayOpen(){if(window.wpOverlay&&window.wpOverlay.state&&window.wpOverlay.state.isOpen)return!0;return null!==document.querySelector(".wp-overlay-container.active")}loadScrollTrigger(t){const e=document.createElement("script");e.src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js",e.onload=t,document.head.appendChild(e)}setMode(t){t!==this.config.mode&&(this.cleanup(),this.config.mode=t,this.init())}cleanup(){this.virtualScrollContainer&&(this.virtualScrollContainer.remove(),this.virtualScrollContainer=null),this.scrollTimeline&&(this.scrollTimeline.kill(),this.scrollTimeline=null),"undefined"!=typeof ScrollTrigger&&ScrollTrigger.getAll().forEach((t=>t.kill())),this._wheelHandler&&(window.removeEventListener("wheel",this._wheelHandler),this._wheelHandler=null),this._touchStartHandler&&(window.removeEventListener("touchstart",this._touchStartHandler),this._touchStartHandler=null),this._touchMoveHandler&&(window.removeEventListener("touchmove",this._touchMoveHandler),this._touchMoveHandler=null),this._keydownHandler&&(document.removeEventListener("keydown",this._keydownHandler),this._keydownHandler=null),document.body.style.overflow="",document.body.style.height="",document.documentElement.style.overflow="",this.mapper.state.currentContainer&&gsap.set(this.mapper.state.currentContainer,{clearProps:"all"}),this.state.currentMarkerIndex=-1,this.state.scrollProgress=0}destroy(){this.cleanup(),this.state.initialized=!1}syncWithClickedMarker(t){if(!t||0===this.state.markers.length)return;const e=this.state.markers.findIndex((e=>e.element===t));-1!==e&&(this.state.currentMarkerIndex=e,void 0!==this._scrollAccumulator&&(this._scrollAccumulator=0),this.state.isNavigating=!0,setTimeout((()=>{this.state.isNavigating=!1}),300))}}